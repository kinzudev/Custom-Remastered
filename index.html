<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Simulador Roblox - Cat√°logo</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <div class="topbar">Simulador de Cat√°logo
    <div id="robuxDisplay"><img src="ROBUX_2014_Logo.svg.png" alt="R$"> <span id="robuxAmount">0</span></div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <h2>Men√∫</h2>
      <a href="#" id="inventoryLink">Inventario</a>
      <a class="upgrade" href="#" id="logoutBtn">Salir</a>
    </aside>

    <main class="main">
      <div class="banner"></div>
      <section class="items">
        <h3 id="sectionTitle">Cat√°logo</h3>
        <div id="controls"></div>
        <div id="itemsGrid" class="grid"></div>
      </section>
    </main>
  </div>

  <div id="authOverlay" class="overlay">
    <div class="modal">
      <h2 id="authTitle">Iniciar sesi√≥n / Registrarse</h2>
      <div class="form-row"><input id="email" type="email" placeholder="Correo electr√≥nico"></div>
      <div class="form-row"><input id="password" type="password" placeholder="Contrase√±a"></div>
      <div style="display:flex;gap:8px"><button id="loginBtn">Iniciar sesi√≥n</button><button id="registerBtn">Registrarse</button></div>
      <p class="muted">Solo <b>kinzudev@gmail.com</b> puede agregar o eliminar √≠tems.</p>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, getDoc, updateDoc, setDoc, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const itemsGrid = document.getElementById('itemsGrid');
    const robuxAmount = document.getElementById('robuxAmount');
    const inventoryLink = document.getElementById('inventoryLink');
    const controls = document.getElementById('controls');
    const sectionTitle = document.getElementById('sectionTitle');
    const authOverlay = document.getElementById('authOverlay');

    let currentUser = null;
    let viewingInventory = false;
    let itemsUnsub = null;

    registerBtn.onclick = async () => {
      try { await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value); }
      catch(e){ alert(e.message); }
    };
    loginBtn.onclick = async () => {
      try { await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value); }
      catch(e){ alert(e.message); }
    };
    logoutBtn.onclick = async () => await signOut(auth);

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if(user){
        authOverlay.style.display='none';
        await initApp();
      } else {
        authOverlay.style.display='flex';
        if(itemsUnsub){itemsUnsub();itemsUnsub=null;}
        itemsGrid.innerHTML='';
      }
    });

    async function initApp(){
      const userRef = doc(db,'users',currentUser.uid);
      await setDoc(userRef,{email:currentUser.email,robux:1000},{merge:true});
      onSnapshot(userRef,snap=>{if(snap.exists())robuxAmount.textContent=snap.data().robux||0;});
      controls.innerHTML='';
      if(currentUser.email==='kinzudev@gmail.com'){
        const btn=document.createElement('button');
        btn.textContent='Agregar √≠tem';
        btn.onclick=adminAddItem;
        controls.appendChild(btn);
      }
      loadItemsRealtime();
    }

    function adminAddItem(){
      const title=prompt('Nombre del √≠tem:');
      if(!title)return;
      const image=prompt('URL de la imagen:')||'';
      const price=parseInt(prompt('Precio (R$):')||'0');
      const rap=parseInt(prompt('RAP:')||'0');
      const stock=parseInt(prompt('Stock disponible:')||'0');
      addDoc(collection(db,'items'),{title,image,price,rap,stock,created:Date.now()});
    }

    function loadItemsRealtime(){
      if(itemsUnsub)itemsUnsub();
      const q=query(collection(db,'items'),orderBy('created','desc'));
      itemsUnsub=onSnapshot(q,snap=>{
        itemsGrid.innerHTML='';
        snap.forEach(s=>{
          const d=s.data();
          const card=document.createElement('div');
          card.className='card';
          card.innerHTML=`
            <img src="${d.image||'https://via.placeholder.com/150'}">
            <div class="title">${d.title||'Sin t√≠tulo'}</div>
            <div class="tag">RAP: ${d.rap||0}</div>
            <div class="price">R$${d.price||0}</div>
            <div class="stock">Stock: ${d.stock||0}</div>
          `;

          if(currentUser.email==='kinzudev@gmail.com'){
            const del=document.createElement('button');
            del.textContent='üóëÔ∏è Eliminar';
            del.className='delete-btn';
            del.onclick=async()=>{if(confirm('¬øEliminar √≠tem?'))await deleteDoc(doc(db,'items',s.id));};
            card.appendChild(del);
          } else {
            const buy=document.createElement('button');
            buy.textContent=d.stock>0?'Comprar':'Sin stock';
            buy.className='buy-btn';
            buy.disabled=d.stock<=0;
            buy.onclick=()=>buyItem(s.id,d);
            card.appendChild(buy);
          }

          itemsGrid.appendChild(card);
        });
      });
    }

    async function buyItem(id,data){
      if(currentUser.email==='kinzudev@gmail.com')return alert("El administrador no puede comprar √≠tems.");
      const itemRef=doc(db,'items',id);
      const itemSnap=await getDoc(itemRef);
      const item=itemSnap.data();
      if(item.stock<=0)return alert("No hay stock disponible.");

      const userRef=doc(db,'users',currentUser.uid);
      const userSnap=await getDoc(userRef);
      const bal=userSnap.data().robux||0;
      if(bal<(item.price||0))return alert('No tienes Robux suficientes.');

      await updateDoc(userRef,{robux:bal-item.price});
      await updateDoc(itemRef,{stock:item.stock-1});
      await addDoc(collection(db,'users',currentUser.uid,'inventory'),{...item,itemId:id,purchasedAt:Date.now()});
      alert('Compra realizada ‚úÖ');
    }

    inventoryLink.onclick=async(e)=>{
      e.preventDefault();
      viewingInventory=!viewingInventory;
      if(viewingInventory){
        sectionTitle.textContent='Inventario';
        if(itemsUnsub){itemsUnsub();itemsUnsub=null;}
        const inv=await getDocs(collection(db,'users',currentUser.uid,'inventory'));
        itemsGrid.innerHTML='';
        inv.forEach(s=>{
          const d=s.data();
          const card=document.createElement('div');
          card.className='card';
          card.innerHTML=`
            <img src="${d.image||'https://via.placeholder.com/150'}">
            <div class="title">${d.title}</div>
            <div class="tag">RAP: ${d.rap}</div>
            <div class="price">R$${d.price}</div>`;
          itemsGrid.appendChild(card);
        });
      } else {
        sectionTitle.textContent='Cat√°logo';
        loadItemsRealtime();
      }
    };
    
  </script>
</body>
</html>
