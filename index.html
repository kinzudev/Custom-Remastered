<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Custom</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <div class="topbar">Estamos trabajando para mejorar la pagina!
    <div id="robuxDisplay"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/ROBUX_2014_Logo.svg/1200px-ROBUX_2014_Logo.svg.png" alt="R$"> <span id="robuxAmount">0</span></div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <h2>Men√∫</h2>
      <a href="#" id="catalogLink">Cat√°logo</a>
      <a href="#" id="inventoryLink">Inventario</a>
      <a class="upgrade" href="#" id="logoutBtn">Salir</a>
    </aside>

    <main class="main">
      <div class="banner"></div>
      <section class="items">
        <h3 id="sectionTitle">Cat√°logo</h3>
        <div id="controls"></div>
        <div id="itemsGrid" class="grid"></div>
      </section>
    </main>
  </div>

  <div id="authOverlay" class="overlay">
    <div class="modal">
      <h2 id="authTitle">Iniciar sesi√≥n / Registrarse</h2>
      <div class="form-row"><input id="email" type="email" placeholder="Correo electr√≥nico"></div>
      <div class="form-row"><input id="password" type="password" placeholder="Contrase√±a"></div>
      <div style="display:flex;gap:8px"><button id="loginBtn">Iniciar sesi√≥n</button><button id="registerBtn">Registrarse</button></div>
      <p class="muted">Solo <b>kinzudev@gmail.com</b> puede agregar o eliminar √≠tems.</p>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, getDoc, updateDoc, setDoc, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const itemsGrid = document.getElementById('itemsGrid');
    const robuxAmount = document.getElementById('robuxAmount');
    const inventoryLink = document.getElementById('inventoryLink');
    const catalogLink = document.getElementById('catalogLink');
    const controls = document.getElementById('controls');
    const sectionTitle = document.getElementById('sectionTitle');
    const authOverlay = document.getElementById('authOverlay');

    let currentUser = null;
    let viewingInventory = false;
    let itemsUnsub = null;

    registerBtn.onclick = async () => {
      try {
        await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      } catch(e){ alert(e.message); }
    };

    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      } catch(e){ alert(e.message); }
    };

    logoutBtn.onclick = async () => await signOut(auth);

    onAuthStateChanged(auth, async user => {
      currentUser = user;
      if(user){
        authOverlay.style.display='none';
        await initApp();
      } else {
        authOverlay.style.display='flex';
        if(itemsUnsub){itemsUnsub();itemsUnsub=null;}
        itemsGrid.innerHTML='';
      }
    });

    async function initApp(){
      const userRef = doc(db,'users',currentUser.uid);
      const snap = await getDoc(userRef);

      // Crear usuario con saldo inicial si no existe
      if(!snap.exists()){
        await setDoc(userRef,{
          email:currentUser.email,
          robux:85,
          lastReward:Date.now()
        });
      } else {
        const data = snap.data();
        // Recompensa diaria
        const now = Date.now();
        const last = data.lastReward || 0;
        const oneDay = 24*60*60*1000;
        if(now - last >= oneDay){
          await updateDoc(userRef,{
            robux:(data.robux||0)+50,
            lastReward:now
          });
          alert('¬°Has recibido tu recompensa diaria de 50 Robux! üéÅ');
        }
      }

      // Actualizar Robux en tiempo real
      onSnapshot(userRef,s=>{if(s.exists())robuxAmount.textContent=s.data().robux||0;});

      controls.innerHTML='';
      if(currentUser.email==='kinzudev@gmail.com'){
        const btn=document.createElement('button');
        btn.textContent='Agregar √≠tem';
        btn.onclick=adminAddItem;
        controls.appendChild(btn);
      }

      loadItemsRealtime();
    }

    function adminAddItem(){
      const title=prompt('Nombre del √≠tem:');
      if(!title)return;
      const image=prompt('URL de la imagen:')||'';
      const price=parseInt(prompt('Precio (R$):')||'0');
      const rap=parseInt(prompt('RAP:')||'0');
      let stockInput=prompt('Stock disponible (0 o vac√≠o = infinito):')||'';
      let stock=stockInput.trim()===''?0:parseInt(stockInput);
      const tagText=prompt('Texto del tag (opcional):')||'';
      let tagBg=null, tagColor=null;
      if(tagText){
        tagBg=prompt('Color de fondo del tag (ej: #ff0000 o red):')||'#ff0000';
        tagColor=prompt('Color del texto del tag (ej: #ffffff o white):')||'#ffffff';
      }
      const timeLimit=prompt('Tiempo limitado en minutos (opcional, vac√≠o = sin l√≠mite):');
      let endTime=null;
      if(timeLimit && !isNaN(timeLimit) && parseInt(timeLimit)>0){
        endTime=Date.now() + parseInt(timeLimit)*60000;
      }

      addDoc(collection(db,'items'),{title,image,price,rap,stock,tagText,tagBg,tagColor,endTime,created:Date.now()});
    }

    function loadItemsRealtime(){
      if(itemsUnsub)itemsUnsub();
      const q=query(collection(db,'items'),orderBy('created','desc'));
      itemsUnsub=onSnapshot(q,snap=>{
        itemsGrid.innerHTML='';
        snap.forEach(s=>{
          const d=s.data();
          const card=document.createElement('div');
          card.className='card';

          // Temporizador
          let timerHTML='';
          if(d.endTime){
            const remain = d.endTime - Date.now();
            timerHTML = remain > 0 ? `<div class="timer">‚è∞ ${Math.floor(remain/60000)}m ${Math.floor((remain%60000)/1000)}s</div>` : `<div class="timer expired">Expirado ‚è∞</div>`;
          }

          card.innerHTML=`
            ${timerHTML}
            <img src="${d.image||'https://via.placeholder.com/150'}">
            <div class="title">${d.title||'Sin t√≠tulo'}</div>
            ${d.tagText ? `<div class="item-tag" style="background:${d.tagBg};color:${d.tagColor};">${d.tagText}</div>` : ''}
            <div class="tag">RAP: ${d.rap||0}</div>
            <div class="price">R$${d.price||0}</div>
            ${d.stock>0 ? `<div class="stock">Stock: ${d.stock}</div>` : ''}
          `;

          const isExpired = d.endTime && Date.now() >= d.endTime;

          if(currentUser.email==='kinzudev@gmail.com'){
            const del=document.createElement('button');
            del.textContent='üóëÔ∏è Eliminar';
            del.className='delete-btn';
            del.onclick=async()=>{if(confirm('¬øEliminar √≠tem?'))await deleteDoc(doc(db,'items',s.id));};
            card.appendChild(del);
          } else {
            const buy=document.createElement('button');
            buy.textContent=isExpired?'Expirado ‚è∞':(d.stock>0 || d.stock===0?'Comprar':'Sin stock');
            buy.className='buy-btn';
            buy.disabled=isExpired || (d.stock>0 && d.stock<=0);
            buy.onclick=()=>buyItem(s.id,d);
            card.appendChild(buy);
          }

          itemsGrid.appendChild(card);
        });
      });
    }

    async function buyItem(id,data){
      if(currentUser.email==='kinzudev@gmail.com')return alert("El administrador no puede comprar √≠tems.");
      const itemRef=doc(db,'items',id);
      const itemSnap=await getDoc(itemRef);
      const item=itemSnap.data();

      if(item.endTime && Date.now()>=item.endTime)return alert("Este √≠tem ha expirado ‚è∞");
      if(item.stock>0 && item.stock<=0)return alert("No hay stock disponible.");

      const userRef=doc(db,'users',currentUser.uid);
      const userSnap=await getDoc(userRef);
      const bal=userSnap.data().robux||0;
      if(bal<(item.price||0))return alert('No tienes Robux suficientes.');

      await updateDoc(userRef,{robux:bal-item.price});
      if(item.stock>0) await updateDoc(itemRef,{stock:item.stock-1});
      await addDoc(collection(db,'users',currentUser.uid,'inventory'),{...item,itemId:id,purchasedAt:Date.now()});
      alert('Compra realizada ‚úÖ');
    }

    catalogLink.onclick = (e)=>{
      e.preventDefault();
      sectionTitle.textContent='Cat√°logo';
      viewingInventory=false;
      loadItemsRealtime();
    };

    inventoryLink.onclick=async(e)=>{
      e.preventDefault();
      viewingInventory=true;
      sectionTitle.textContent='Inventario';
      if(itemsUnsub){itemsUnsub();itemsUnsub=null;}
      const inv=await getDocs(collection(db,'users',currentUser.uid,'inventory'));
      itemsGrid.innerHTML='';
      inv.forEach(s=>{
        const d=s.data();
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`
          <img src="${d.image||'https://via.placeholder.com/150'}">
          <div class="title">${d.title}</div>
          ${d.tagText ? `<div class="item-tag" style="background:${d.tagBg};color:${d.tagColor};">${d.tagText}</div>` : ''}
          <div class="tag">RAP: ${d.rap}</div>
          <div class="price">R$${d.price}</div>`;
        itemsGrid.appendChild(card);
      });
    };

    // Fondo animado
    const c=document.getElementById('bgCanvas');
    const ctx=c.getContext('2d');
    let w,h,balls=[];
    function resize(){w=window.innerWidth;h=window.innerHeight;c.width=w;c.height=h;}
    window.onresize=resize;resize();
    for(let i=0;i<50;i++)balls.push({x:Math.random()*w,y:Math.random()*h,r:Math.random()*3+1,dx:(Math.random()-0.5)*2,dy:(Math.random()-0.5)*2});
    function animate(){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="#fff";
      for(let b of balls){
        b.x+=b.dx;b.y+=b.dy;
        if(b.x<0||b.x>w)b.dx*=-1;
        if(b.y<0||b.y>h)b.dy*=-1;
        ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();
      }
      requestAnimationFrame(animate);
    }
    animate();
  </script>

<script>
// Asegura desplazamiento suave en toda la p√°gina
document.documentElement.style.scrollBehavior = "smooth";

<script type="module">
/*
  Panel admin (Insert) ‚Äî destinatarios cargados desde Firestore (colecci√≥n `users`).
  Requisitos: Firebase app inicializado, Firestore con docs en 'users/{uid}' que contengan campo 'email'.
  Usa las Cloud Functions 'adminAddRobux' y 'adminGiveItem' como callable.
*/

import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const auth = getAuth();
const functions = getFunctions();
const db = getFirestore();

let currentUser = null;
onAuthStateChanged(auth, (u) => currentUser = u);

window.addEventListener('keydown', async (e) => {
  if (e.key !== 'Insert') return;
  if (!currentUser || currentUser.email !== "kinzudev@gmail.com") return;

  const existing = document.getElementById("adminPanel");
  if (existing) { existing.remove(); return; }
  await createAdminPanel(); // espera a que cargue la lista de users
});

async function fetchUsersEmails() {
  try {
    const snap = await getDocs(collection(db, 'users'));
    const emails = [];
    snap.forEach(d => {
      const data = d.data();
      if (data && data.email) emails.push({ uid: d.id, email: String(data.email).toLowerCase() });
    });
    return emails;
  } catch (err) {
    console.error('Error fetch users:', err);
    return [];
  }
}

async function createAdminPanel() {
  const panel = document.createElement('div');
  panel.id = 'adminPanel';
  panel.style.cssText = `
    position:fixed;right:18px;top:80px;z-index:99999;
    width:420px;max-width:95vw;background:linear-gradient(180deg,#111,#0e0e0e);
    border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);
    color:#fff;font-family:Arial,Helvetica,sans-serif;
  `;

  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="margin:0;font-size:16px">Panel Admin (Insert)</h3>
      <button id="closeAdminPanel" style="background:#222;border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer">‚úï</button>
    </div>

    <select id="adminAction" style="width:100%;padding:8px;border-radius:8px;background:#181818;color:#fff;border:1px solid #333;margin-bottom:12px">
      <option value="robux">A√±adir Robux</option>
      <option value="item">Regalar √çtem</option>
    </select>

    <div id="robuxFields">
      <label style="font-size:13px;color:#ccc">Selecciona destinatario (desde Firestore):</label>
      <select id="robuxSelect" style="width:100%;padding:8px;border-radius:6px;border:none;background:#0f0f0f;color:#fff;margin:6px 0"></select>
      <div style="text-align:center;color:#888;margin-bottom:8px">o escribe manualmente</div>
      <input id="robuxEmailManual" type="email" placeholder="Email destinatario (manual)" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
      <input id="robuxAmount" type="number" placeholder="Cantidad de Robux" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
      <button id="sendRobuxBtn" style="background:#0a84ff;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;width:100%">Enviar Robux</button>
    </div>

    <div id="itemFields" style="display:none">
      <label style="font-size:13px;color:#ccc">Selecciona destinatario (desde Firestore):</label>
      <select id="itemSelect" style="width:100%;padding:8px;border-radius:6px;border:none;background:#0f0f0f;color:#fff;margin:6px 0"></select>
      <div style="text-align:center;color:#888;margin-bottom:8px">o escribe manualmente</div>
      <input id="itemEmailManual" type="email" placeholder="Email destinatario (manual)" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">

      <input id="itemName" type="text" placeholder="Nombre del √≠tem" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
      <input id="itemImage" type="text" placeholder="URL de imagen" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
      <input id="itemTagText" type="text" placeholder="Texto del tag (opcional)" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
      <div style="display:flex;gap:8px">
        <input id="itemTagBg" type="text" placeholder="Color fondo tag (#ff0000)" style="flex:1;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
        <input id="itemTagColor" type="text" placeholder="Color texto tag (#ffffff)" style="flex:1;padding:8px;border-radius:6px;border:1px solid #222;background:#0f0f0f;color:#fff">
      </div>
      <div style="height:10px"></div>
      <button id="sendItemBtn" style="background:#00c853;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;width:100%">Enviar √çtem</button>
    </div>

    <div id="adminMsg" style="margin-top:10px;font-size:13px;color:#ccc"></div>
  `;

  document.body.appendChild(panel);

  document.getElementById("closeAdminPanel").onclick = () => panel.remove();

  const adminAction = document.getElementById("adminAction");
  const robuxFields = document.getElementById("robuxFields");
  const itemFields = document.getElementById("itemFields");
  const robuxSelect = document.getElementById("robuxSelect");
  const itemSelect = document.getElementById("itemSelect");
  const robuxEmailManual = document.getElementById("robuxEmailManual");
  const itemEmailManual = document.getElementById("itemEmailManual");

  adminAction.onchange = () => {
    const action = adminAction.value;
    robuxFields.style.display = action === "robux" ? "block" : "none";
    itemFields.style.display = action === "item" ? "block" : "none";
  };

  // cargar lista de usuarios desde Firestore y poblarla en los selects
  const emails = await fetchUsersEmails();
  function populateSelect(sel, list) {
    sel.innerHTML = '';
    if (!list.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'No hay usuarios en Firestore';
      sel.appendChild(opt);
      return;
    }
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '-- seleccionar usuario --';
    sel.appendChild(placeholder);
    for (const u of list) {
      const o = document.createElement('option');
      o.value = u.email;
      o.textContent = u.email;
      sel.appendChild(o);
    }
  }
  populateSelect(robuxSelect, emails);
  populateSelect(itemSelect, emails);

  // Enviar Robux (usa callable function)
  document.getElementById("sendRobuxBtn").onclick = async () => {
    const msg = document.getElementById("adminMsg");
    const selected = robuxSelect.value;
    const manual = robuxEmailManual.value.trim().toLowerCase();
    const targetEmail = selected || manual;
    const amount = Number(document.getElementById("robuxAmount").value || 0);

    if (!targetEmail || amount <= 0) {
      msg.style.color = "#ff8a80";
      msg.textContent = "Selecciona destinatario o escribe un email v√°lido, y cantidad > 0.";
      return;
    }

    msg.style.color = "#ccc";
    msg.textContent = "Enviando Robux...";

    try {
      const fn = httpsCallable(functions, "adminAddRobux");
      const res = await fn({ targetEmail, amount });
      msg.style.color = "#8bc34a";
      msg.textContent = res.data?.message || "Robux enviados correctamente.";
    } catch (err) {
      console.error(err);
      msg.style.color = "#ff8a80";
      msg.textContent = err?.message || "Error al enviar Robux.";
    }
  };

  // Enviar √çtem (usa callable function)
  document.getElementById("sendItemBtn").onclick = async () => {
    const msg = document.getElementById("adminMsg");
    const selected = itemSelect.value;
    const manual = itemEmailManual.value.trim().toLowerCase();
    const targetEmail = selected || manual;

    const title = document.getElementById("itemName").value.trim();
    const image = document.getElementById("itemImage").value.trim();
    const tagText = document.getElementById("itemTagText").value.trim();
    const tagBg = document.getElementById("itemTagBg").value.trim() || '#000';
    const tagColor = document.getElementById("itemTagColor").value.trim() || '#fff';

    if (!targetEmail || !title || !image) {
      msg.style.color = "#ff8a80";
      msg.textContent = "Selecciona destinatario o escribe email; completa nombre e imagen.";
      return;
    }

    msg.style.color = "#ccc";
    msg.textContent = "Enviando √≠tem...";

    try {
      const fn = httpsCallable(functions, "adminGiveItem");
      const res = await fn({
        targetEmail,
        item: { title, image, tagText, tagBg, tagColor }
      });
      msg.style.color = "#8bc34a";
      msg.textContent = res.data?.message || "√çtem enviado correctamente.";
    } catch (err) {
      console.error(err);
      msg.style.color = "#ff8a80";
      msg.textContent = err?.message || "Error al enviar √≠tem.";
    }
  };
}
</script>

</body>
</html>
