<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Simulador Roblox - Catalog</title>
  <style>
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:#222;color:#222}
    a{color:inherit;text-decoration:none}

    .topbar{background:#f60;color:#fff;padding:10px 18px;text-align:center;font-weight:700;position:relative}
    #robuxDisplay{position:absolute;top:6px;right:20px;display:flex;align-items:center;gap:6px;font-weight:bold;color:#00aa00}
    #robuxDisplay img{width:26px;height:26px}

    .app{display:flex;min-height:calc(100vh - 40px)}
    .sidebar{width:220px;background:#2f2f2f;color:#ddd;padding:18px}
    .sidebar h2{color:#fff;font-size:16px;margin:6px 0}
    .sidebar a{display:block;color:#bfbfbf;padding:8px 4px}
    .upgrade{display:inline-block;background:#08f;color:#fff;padding:8px 10px;border-radius:4px;margin-top:12px}

    .main{flex:1;padding:18px;background:#fafafa}
    .banner{height:120px;background-image:url('/mnt/data/59983a73-6d5c-45b0-9e3d-d39c2935bedf.png');background-size:cover;background-position:center;margin-bottom:12px;border-radius:4px}

    .items{flex:1}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px}
    .card{background:#fff;border:1px solid #ddd;padding:10px;border-radius:6px;text-align:center;cursor:pointer;transition:transform 0.15s}
    .card:hover{transform:scale(1.04)}
    .card img{width:100%;height:120px;object-fit:contain;border-bottom:1px solid #ddd;margin-bottom:6px}
    .card .title{font-size:14px;margin:4px 0;color:#333;font-weight:bold}
    .card .tag{font-size:12px;color:#666}
    .card .price{color:#0a8b00;font-weight:700;font-size:13px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
    .modal{background:#fff;padding:20px;border-radius:8px;max-width:420px;width:100%}
    .modal h2{margin-top:0}
    .form-row{margin-bottom:10px}
    input[type=text],input[type=password],input[type=email]{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
    button{padding:8px 12px;border:0;border-radius:6px;background:#0666ff;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:13px}

    @media (max-width:800px){.sidebar{display:none}.banner{height:90px}}
  </style>
</head>
<body>
  <div class="topbar">Simulador de Catálogo
    <div id="robuxDisplay"><img src="/mnt/data/ROBUX_2014_Logo.svg.png" alt="R$"> <span id="robuxAmount">0</span></div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <h2>Menú</h2>
      <a href="#" id="inventoryLink">Inventario</a>
      <a class="upgrade" href="#" id="logoutBtn">Salir</a>
    </aside>

    <main class="main">
      <div class="banner" aria-hidden="true"></div>

      <section class="items">
        <h3 id="sectionTitle">Catálogo</h3>
        <div id="controls"></div>
        <div id="itemsGrid" class="grid"></div>
      </section>
    </main>
  </div>

  <!-- Auth modal -->
  <div id="authOverlay" class="overlay">
    <div class="modal">
      <h2 id="authTitle">Iniciar sesión / Registrarse</h2>
      <div class="form-row"><input id="email" type="email" placeholder="Correo electrónico"></div>
      <div class="form-row"><input id="password" type="password" placeholder="Contraseña"></div>
      <div style="display:flex;gap:8px"><button id="loginBtn">Iniciar sesión</button><button id="registerBtn">Registrarse</button></div>
      <p class="muted">Solo el usuario <b>kinzudev@gmail.com</b> puede agregar ítems al catálogo.</p>
    </div>
  </div>

  <script type="module">
    // Firebase config (provided)
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import {
      getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, setDoc, getDocs, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authOverlay = document.getElementById('authOverlay');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const itemsGrid = document.getElementById('itemsGrid');
    const robuxAmount = document.getElementById('robuxAmount');
    const inventoryLink = document.getElementById('inventoryLink');
    const controls = document.getElementById('controls');
    const sectionTitle = document.getElementById('sectionTitle');

    let currentUser = null;
    let viewingInventory = false;
    let itemsUnsub = null;

    // Auth handlers
    registerBtn.addEventListener('click', async()=>{
      try{await createUserWithEmailAndPassword(auth,emailInput.value.trim(),passwordInput.value);}catch(e){alert('Error: '+e.message)}
    });
    loginBtn.addEventListener('click', async()=>{
      try{await signInWithEmailAndPassword(auth,emailInput.value.trim(),passwordInput.value);}catch(e){alert('Error: '+e.message)}
    });
    logoutBtn.addEventListener('click', async()=>{await signOut(auth);});

    onAuthStateChanged(auth, async user=>{
      currentUser = user;
      if(user){
        authOverlay.style.display = 'none';
        await initApp();
      } else {
        authOverlay.style.display = 'flex';
        itemsGrid.innerHTML = '';
        robuxAmount.textContent = '0';
        controls.innerHTML = '';
        sectionTitle.textContent = 'Catálogo';
        if(itemsUnsub){itemsUnsub(); itemsUnsub = null}
      }
    });

    async function initApp(){
      // Ensure user doc exists with robux balance
      const userRef = doc(db,'users',currentUser.uid);
      await setDoc(userRef,{email:currentUser.email,robux:1000},{merge:true});
      // Listen to balance
      onSnapshot(userRef,snap=>{if(snap.exists())robuxAmount.textContent = snap.data().robux ?? 0});

      controls.innerHTML = '';
      if(currentUser.email === 'kinzudev@gmail.com'){
        const btn = document.createElement('button'); btn.textContent = 'Agregar ítem';
        btn.onclick = adminAddItem; controls.appendChild(btn);
      }

      // Default view: catálogo
      viewingInventory = false;
      sectionTitle.textContent = 'Catálogo';
      loadItemsRealtime();
    }

    function adminAddItem(){
      const title = prompt('Nombre del ítem (aparecerá arriba del tag):');
      if(!title) return;
      const image = prompt('URL de la imagen:') || '';
      const price = parseInt(prompt('Precio (R$):') || '0',10);
      const rap = parseInt(prompt('RAP (valor estimado):') || '0',10);
      addDoc(collection(db,'items'),{title,image,price,rap,created: Date.now()}).then(()=>alert('Ítem agregado')).catch(e=>alert('Error: '+e.message));
    }

    function loadItemsRealtime(){
      if(itemsUnsub) itemsUnsub();
      const q = query(collection(db,'items'), orderBy('created','desc'));
      itemsUnsub = onSnapshot(q, snap=>{
        itemsGrid.innerHTML = '';
        snap.forEach(s=>{
          const d = s.data();
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `\n            <img src="${escapeHtml(d.image||'https://via.placeholder.com/150')}" alt="">\n            <div class="title">${escapeHtml(d.title||'Sin título')}</div>\n            <div class="tag">RAP: ${d.rap||0}</div>\n            <div class="price">R$${d.price||0}</div>`;
          card.onclick = ()=>buyItem(s.id,d);
          itemsGrid.appendChild(card);
        });
      }, err=>{console.error(err); alert('Error cargando items: '+err.message)});
    }

    async function buyItem(id,data){
      if(!currentUser) return alert('Inicia sesión para comprar');
      try{
        const userRef = doc(db,'users',currentUser.uid);
        const userSnap = await getDoc(userRef);
        const balance = (userSnap.exists() && userSnap.data().robux) ? userSnap.data().robux : 0;
        if(balance < (data.price||0)) return alert('No tienes Robux suficientes');
        // deduct
        await updateDoc(userRef,{robux: balance - (data.price||0)});
        // add to inventory
        await addDoc(collection(db,'users',currentUser.uid,'inventory'),{itemId:id,title:data.title,image:data.image,price:data.price,rap:data.rap,purchasedAt:Date.now()});
        alert('Compra exitosa');
      }catch(e){console.error(e);alert('Error al comprar: '+e.message)}
    }

    inventoryLink.addEventListener('click', async (e)=>{
      e.preventDefault();
      if(!currentUser) return alert('Inicia sesión');
      viewingInventory = !viewingInventory;
      if(viewingInventory){
        sectionTitle.textContent = 'Inventario';
        if(itemsUnsub){itemsUnsub(); itemsUnsub = null}
        await showInventory();
      } else {
        sectionTitle.textContent = 'Catálogo';
        loadItemsRealtime();
      }
    });

    async function showInventory(){
      itemsGrid.innerHTML = '';
      try{
        const invSnap = await getDocs(collection(db,'users',currentUser.uid,'inventory'));
        invSnap.forEach(s=>{
          const d = s.data();
          const card = document.createElement('div'); card.className='card';
          card.innerHTML = `\n            <img src="${escapeHtml(d.image||'https://via.placeholder.com/150')}" alt="">\n            <div class="title">${escapeHtml(d.title||'Sin título')}</div>\n            <div class="tag">RAP: ${d.rap||0}</div>\n            <div class="price">R$${d.price||0}</div>`;
          itemsGrid.appendChild(card);
        });
      }catch(e){console.error(e);alert('Error cargando inventario: '+e.message)}
    }

    function escapeHtml(s){return String(s).replace(/[&<>"']/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]})}
  </script>
</body>
</html>
